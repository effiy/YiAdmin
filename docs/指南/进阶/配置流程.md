# é…ç½®æµç¨‹

## èƒŒæ™¯

vue é¡¹ç›® build ç”Ÿäº§çš„æ‰“åŒ…æ–‡ä»¶ä¸¢åˆ°æœåŠ¡å™¨åï¼Œå‘ç°è¿˜æ˜¯ä¸Šä¸€æ¬¡çš„æ•ˆæœï¼Œæ–°ä¿®æ”¹çš„ä¸èµ·æ•ˆï¼Œæ¯æ¬¡éƒ½éœ€è¦ `ctrl+F5` å¼ºåˆ¶åˆ·æ–°é¡µé¢ã€‚

ä¸ºå•¥ï¼Ÿ

é¡¹ç›®éƒ¨ç½²åé¡µé¢æœªåˆ·æ–°ç›¸å…³ç¼“å­˜é—®é¢˜å¯¼è‡´çš„ï¼š
- åŒ…æ‹¬ HTTP ç¼“å­˜çš„å¼ºç¼“å­˜ï¼šexpiresã€cache-control
- åå•†ç¼“å­˜ï¼šLast-Modifiedã€If-Modified-Sinceã€Etagã€If-None-Match
- æœ¬åœ°ç¼“å­˜ï¼šdisk cacheã€memory cache
- CDN ç¼“å­˜ï¼šå¼ºåˆ¶ç¼“å­˜ã€è¡¥å……ç¼“å­˜(éµå¾ªæºç«™)ã€‚å¤§éƒ¨åˆ† CDN æœåŠ¡å•†ï¼ˆå¦‚ Cloudflareã€Akamaiã€Fastly ç­‰ï¼‰ä¼šåœ¨ HTTP å“åº”å¤´ä¸­æ·»åŠ ç‰¹å®šçš„æ ‡è¯†ï¼Œè¡¨ç¤ºå“åº”æ˜¯é€šè¿‡ CDN ç¼“å­˜æä¾›çš„ï¼Œæ¯”å¦‚ Ageï¼šè¿™ä¸ªå¤´éƒ¨è¡¨ç¤ºå“åº”å·²ç»åœ¨ CDN ç¼“å­˜ä¸­å­˜å‚¨çš„æ—¶é—´ã€‚é€šå¸¸å¦‚æœè¯¥å€¼å¤§äºé›¶ï¼Œæ„å‘³ç€å“åº”æ¥è‡ªç¼“å­˜ã€‚Age: 3600 è¡¨ç¤ºå“åº”å·²ç»ç¼“å­˜äº†ä¸€ä¸ªå°æ—¶ã€‚

å¦‚ä½•è§£å†³ï¼Ÿ

nginx é…ç½®å…¥å£æ–‡ä»¶ index.html ç¦æ­¢ç¼“å­˜å¹¶é‡æ–°åˆ·ä¸€ä¸‹ CDN ç¼“å­˜ã€‚

## ç›®æ ‡

é€šè¿‡ä¼˜åŒ– Nginx é…ç½®ï¼Œæé«˜å‰ç«¯é¡¹ç›®çš„åŠ è½½é€Ÿåº¦ï¼Œå¢å¼ºå®‰å…¨æ€§ï¼ŒåŒæ—¶æ”¹å–„ç”¨æˆ·ä½“éªŒï¼Œç¡®ä¿é™æ€èµ„æºé«˜æ•ˆç¼“å­˜å¹¶åŠ é€ŸåŠ è½½ã€‚

---

ğŸï¸ **æ€§èƒ½ä¼˜åŒ–**ï¼š
- **å‹ç¼©ç‡è°ƒæ•´**ï¼š `gzip_comp_level` è®¾ç½®ä¸º `6`ï¼Œå¹³è¡¡å‹ç¼©å’Œæ€§èƒ½ã€‚åœ¨æŸäº›é«˜æµé‡ç½‘ç«™ä¸­ï¼Œå‹ç¼©çº§åˆ«å¯èƒ½ç¨å¾®å½±å“æœåŠ¡å™¨æ€§èƒ½ï¼Œå¯ä»¥æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´ã€‚

ğŸ”’ **å®‰å…¨æ€§æå‡**ï¼š
- **éšè—æœåŠ¡å™¨ç‰ˆæœ¬ä¿¡æ¯**ï¼š `server_tokens off`ï¼Œé˜²æ­¢æ³„æ¼æœåŠ¡å™¨ç‰ˆæœ¬ï¼Œå‡å°‘æ½œåœ¨çš„æ”»å‡»é¢ã€‚
- **å¼ºåˆ¶ä½¿ç”¨ HTTPS**ï¼šé€šè¿‡å¯ç”¨ HSTSï¼ˆä¸¥æ ¼ä¼ è¾“å®‰å…¨ï¼‰å¤´éƒ¨ï¼Œé˜²æ­¢åè®®é™çº§æ”»å‡»ã€‚
- **CORS è®¾ç½®**ï¼šå¯¹äºè·¨åŸŸè¯·æ±‚ï¼Œå»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒä¸­é¿å…ä½¿ç”¨ `*` æ¥å…è®¸æ‰€æœ‰æºçš„è®¿é—®ï¼Œå¯ä»¥æ ¹æ®å®é™…éœ€æ±‚é™åˆ¶è®¿é—®çš„åŸŸåã€‚

ğŸ‘¨â€ğŸ’» **ç”¨æˆ·ä½“éªŒæ”¹è¿›**ï¼š
- **æ›´ç²¾ç»†çš„ç¼“å­˜æ§åˆ¶**ï¼š
  - å¯¹ HTML æ–‡ä»¶ç¦ç”¨ç¼“å­˜ï¼Œç¡®ä¿ç”¨æˆ·è®¿é—®æ—¶å§‹ç»ˆåŠ è½½æœ€æ–°ç‰ˆæœ¬çš„ç½‘é¡µã€‚
  - å¯¹äº JS å’Œ CSS ç­‰æ–‡ä»¶ï¼Œä¸ºäº†è¿›ä¸€æ­¥ä¿è¯æ–‡ä»¶ç‰ˆæœ¬ä¸€è‡´æ€§ï¼Œå¯ä»¥ç¡®ä¿æ„å»ºå·¥å…·åœ¨æ‰“åŒ…æ—¶ä¸ºæ–‡ä»¶åŠ å…¥ hash å€¼ï¼Œå¹¶åœ¨ç¼“å­˜ç­–ç•¥ä¸­åˆ©ç”¨è¿™äº› hash å€¼ã€‚
  - å¯¹äºå›¾ç‰‡èµ„æºï¼Œæ ¹æ®å›¾ç‰‡çš„æ›´æ–°é¢‘ç‡è°ƒæ•´ max-age è®¾ç½®ï¼Œå‡å°‘ç”¨æˆ·çš„èµ„æºè¯·æ±‚é¢‘ç‡ã€‚
- **HTTP/2 æ”¯æŒ**ï¼šå¯ç”¨ HTTP/2 æå‡å¤šè¯·æ±‚å¹¶å‘æ€§èƒ½ã€‚
- **404 é¡µé¢å¤„ç†**ï¼šè‡ªå®šä¹‰ 404 é”™è¯¯é¡µé¢ï¼Œè®©ç”¨æˆ·å‹å¥½åœ°çŸ¥é“èµ„æºä¸å­˜åœ¨ã€‚

---

## æªæ–½

1. **æ€§èƒ½ä¼˜åŒ–ï¼šå‹ç¼©è®¾ç½®**
  ```nginx
    gzip on;
    gzip_min_length 1k;
    gzip_comp_level 6; # æé«˜å‹ç¼©ç‡ï¼Œä½†é¿å…è¿‡é«˜å½±å“æ€§èƒ½
    gzip_types text/plain application/javascript application/json application/x-javascript text/javascript text/xml text/css image/svg+xml;
    gzip_disable "MSIE [1-6]\.";
    gzip_static on;
    gzip_vary on;
  ```

2. **ç¼“å­˜è®¾ç½®ï¼šé™æ€æ–‡ä»¶ç¼“å­˜**
   ```nginx
    # JSã€CSS ç­‰åŠ¨æ€å˜åŒ–è¾ƒé¢‘ç¹çš„æ–‡ä»¶ï¼Œå¯ä»¥é‡‡ç”¨ hash ç­–ç•¥è¿›è¡Œæ–‡ä»¶ç‰ˆæœ¬ç®¡ç†ï¼Œç¡®ä¿ç¼“å­˜çš„åŠæ—¶æ›´æ–°
    location ~* \.(js|css)$ {
        add_header Cache-Control "public, immutable, max-age=31536000";
        try_files $uri $uri/ /index.html;
    }
    # å¯¹äºå›¾ç‰‡ç­‰èµ„æºï¼Œé€‚å½“è®¾ç½®è¾ƒé•¿çš„ç¼“å­˜æ—¶é—´
    location ~* \.(jpg|jpeg|png|gif|ico|svg|woff|woff2|ttf|eot|otf)$ {
        add_header Cache-Control "public, max-age=31536000, immutable";
    }
   ```

3. **å®‰å…¨æ€§æå‡ï¼šHSTS è®¾ç½®**
  ```nginx
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
  ```

4. **HTML æ–‡ä»¶ç¼“å­˜ç¦ç”¨**
   ```nginx
    location ~* \.(html|htm)$ {
        add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0";
        add_header Pragma no-cache;
        add_header Expires 0;
    }
   ```

5. **é”™è¯¯é¡µé¢ä¼˜åŒ–**
   ```nginx
   error_page 404 /404.html;
   location = /404.html {
       internal;
   }

   error_page 500 502 503 504 /50x.html;
   location = /50x.html {
       internal;
   }
   ```

## æ­¥éª¤

``` nginx.conf
user nginx;
worker_processes auto;
worker_rlimit_nofile 65535;  # å¢åŠ æœ€å¤§æ–‡ä»¶æ‰“å¼€é™åˆ¶

error_log /var/log/nginx/error.log notice;
pid /var/run/nginx.pid;

events {
    multi_accept on;
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # éšè—æœåŠ¡å™¨ç‰ˆæœ¬ä¿¡æ¯
    server_tokens off; 

    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

    access_log /var/log/nginx/access.log main;
    error_log /var/log/nginx/error.log warn;

    # æ€§èƒ½ä¼˜åŒ–
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;

    # å‹ç¼©è®¾ç½®
    gzip on;
    gzip_min_length 1k;
    gzip_comp_level 6; # æé«˜å‹ç¼©ç‡ï¼Œä½†é¿å…è¿‡é«˜å½±å“æ€§èƒ½
    gzip_types text/plain application/javascript application/json application/x-javascript text/javascript text/xml text/css image/svg+xml;
    gzip_disable "MSIE [1-6]\.";
    gzip_static on;
    gzip_vary on;

    # æ·»åŠ  HTTP/2 æ”¯æŒ
    http2_max_concurrent_streams 128;

    # ç¼“å­˜ä¸å®‰å…¨å¤´
    etag on;

    server {
        listen 80;
        listen [::]:80;
        server_name _;
        root /home/web/dist;

        # å…¨å±€ CORS è®¾ç½®ï¼Œå¯ä»¥æ ¹æ®å®é™…éœ€æ±‚é™åˆ¶è®¿é—®çš„åŸŸå
        add_header Access-Control-Allow-Origin *;
        add_header Access-Control-Allow-Methods "GET, POST, OPTIONS";
        add_header Access-Control-Allow-Headers "$http_access_control_request_headers";

        # å¢å¼ºå®‰å…¨å¤´éƒ¨
        add_header X-Content-Type-Options "nosniff" always;
        # é˜²æ­¢ Clickjacking æ”»å‡»ï¼š
        add_header X-Frame-Options "DENY" always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header Referrer-Policy "no-referrer-when-downgrade" always;

        # OPTIONS è¯·æ±‚ç‰¹æ®Šå¤„ç†
        if ($request_method = 'OPTIONS') {
            return 204;
        }

        # HTTP åˆ° HTTPS å¼ºåˆ¶é‡å®šå‘
        # return 301 https://$server_name$request_uri;

        # æ£€æŸ¥ HTTPS é…ç½®åä½¿ç”¨ HSTSï¼Œé˜²æ­¢åè®®é™çº§æ”»å‡»
        # add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

        location / {
            try_files $uri $uri/ /index.html;
        }

        # é™æ€èµ„æºç¼“å­˜ç­–ç•¥
        # JSã€CSS ç­‰åŠ¨æ€å˜åŒ–è¾ƒé¢‘ç¹çš„æ–‡ä»¶ï¼Œå¯ä»¥é‡‡ç”¨ hash ç­–ç•¥è¿›è¡Œæ–‡ä»¶ç‰ˆæœ¬ç®¡ç†ï¼Œç¡®ä¿ç¼“å­˜çš„åŠæ—¶æ›´æ–°
        location ~* \.(js|css)$ {
            add_header Cache-Control "public, immutable, max-age=31536000";
            try_files $uri $uri/ /index.html;
        }
        # å¯¹äºå›¾ç‰‡ç­‰èµ„æºï¼Œé€‚å½“è®¾ç½®è¾ƒé•¿çš„ç¼“å­˜æ—¶é—´
        location ~* \.(jpg|jpeg|png|gif|ico|svg|woff|woff2|ttf|eot|otf)$ {
            add_header Cache-Control "public, max-age=31536000, immutable";
        }

        # HTML æ–‡ä»¶ç¼“å­˜ç¦ç”¨
        location ~* \.(html|htm)$ {
            add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0";
            add_header Pragma no-cache;
            add_header Expires 0;
        }

        # é”™è¯¯é¡µé¢å¤„ç†
        error_page 404 /404.html;
        location = /404.html {
            internal;
        }

        error_page 500 502 503 504 /50x.html;
        location = /50x.html {
            internal;
        }
    }

    include /etc/nginx/conf.d/*.conf;
}
```
